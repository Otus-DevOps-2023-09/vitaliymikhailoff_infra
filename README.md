# vitaliymikhailoff_infra
vitaliymikhailoff Infra repository

## Знакомство с Yandex Cloud.

### Основное задание:
Конфигурация cloud-bastion.ovpn позволяет подключаться до созданных в облаке Yandex Cloud виртуальных машин, маршрут настроен только на подсеть 10.128.0.0/24.  
bastion_IP = 51.250.65.60  
someinternalhost_IP = 10.128.0.17  

### Самостоятельное задание:
Для подключения к хосту someinternalhost одной командой, необходимо создать следующий alias:  
alias someinternalhost='ssh -i .ssh/yc_key -A appuser@51.250.65.60 "ssh -tt 10.128.0.17"'  
После добавления alias можно подключаться одной командой - someinternalhost  

### Дополнительное задание:
Настроен Let's Encrypt сертификат для доступа к web панели pritunl.  
URL: https://vpn.mikhailov.cf  


## Основные сервисы Yandex Cloud

### Основное задание:
testapp_IP = 51.250.93.11  
testapp_port = 9292  

### Дополнительное задание:
Написал startup config - yc-config.txt
Команда CLI для развертки ВМ с применением конфига:

yc compute instance create \
  --name reddit-app \
  --hostname reddit-app \
  --memory=4 \
  --create-boot-disk image-folder-id=standard-images,image-family=ubuntu-1604-lts,size=10GB \
  --network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4 \
  --metadata serial-port-enable=1 \
  --metadata-from-file user-data=yc-config.txt

В результате получаем ВМ с развернутым приложением.


## Модели управления инфраструктурой. Подготовка образов с помощью Packer   

### Основное задание:  
Создан сервисный аккаунт с ролью editor для packer  
Создан файл-шаблон **ubuntu16.json**, который создает образ ubuntu с предустановленными Ruby и Mongodb  
Собран образ из шаблона **ubuntu16.json**, а также развернута ВМ из этого образа  
В ВМ установлен и запущен Reddit  
Создан **variables.json**, в котором описаны переменные для файла-шаблона, также создан **variables.json.example**  
В .gitingonre добавлен файл **variables.json**  

### Дополнительное задание:  
Создан файл-шаблон **immutable.json** для создания bake образа ubuntu, с предустановленными Ruby и Mongodb, а также запущенным Reddit через systemd - **files/systemd-app**  
Собран образ из шаблона **immutable.json**, а также развернута ВМ из этого образа  

### Дополнительное задание:  
Создан скрипт **create-reddit-vm.sh**, позволяющий создать ВМ из bake образа при помощи YC CLI, с запущенным приложением Reddit.  
Развернута ВМ при помощи скрипта **create-reddit-vm.sh**  


## Знакомство с Terraform

### Основное задание:
Создан сервисный аккаунт с ролью editor для terraform  
Создан файл **main.tf**, при помощи которого разворачивается ВМ из ранее подготовленного образа, с предустановленными Ruby и Mongodb, а также запущенным приложением Reddit с использованием systemd  
Настроен вывод необходимых переменных после деплоя ВМ в файле **outputs.tf**  
Настроен вынос переменных при помощи файлов **variables.tf** и **terraform.tfvars**  

### Дополнительное задание:
Создан файл **lb.tf**, при помощи которого разворачивается HTTP балансировщик, а также создается целевая группа из двух ВМ с приложением Reddit  
Файл **main.tf** доработан для развертки двух одинаковых инстансов с использованием переменной count  
В итоге при применении конфигов, получаем две ВМ с приложением Reddit, а также балансировщик, направленный на эти две ВМ  


## Принципы организации инфраструктурного кода и работа над инфраструктурой в команде на примере Terraform  

### Основное задание:  
Описано создание отдельной сети и подсети в **main.tf**, а также настройка, при создании ВМ - подключение ВМ к созданной сети и подсети  
Созданы дополнительные образы при помощи packer для ВМ с приложением и ВМ с БД.  
Для ВМ с приложением и ВМ с БД указаны разные образы  
Разбит основной конфиг **main.tf** на несколько, далее было переделано в модули  
Созданы два модуля **app** и **db**, подкручены конфиги для их работы  
Созданы подпроекты **stage** и **prod**  
Добавлены переменные для добавления к именам ВМ приставки названия подпроекта - **stage** или **prod**  
Все настройки продублированы в подпроектах **stage** и **prod**  

### Дополнительное задание:  
Cборка нового образа для ВМ с БД. Дополнительно в скрипт **install_mongodb.sh** добавлена команда для изменения файла **/etc/mongodb.conf** для возможности подключения к БД из вне, собран дополнительный образ.  
Добавлен **provisioner** в модуль **app** для копирования файла systemd  
Для указания приложению адреса ВМ с БД в модуле **app** добавлен **provisioner "remote-exec"**, который добавляет в systemd переменную с указанием внутреннего адреса ВМ с БД  
Добавлен **provisioner** в модуль **app** для выполнения скрипта деплоя приложения  
Для ВМ с БД удалена настройка создания внешнего ip, используется только внутренний, outputs так же изменены для ВМ с БД для выдачи внутреннего ip  
По итогу получаем terraform конфиги, после применения которых создаются две ВМ - приложение и БД. Приложение доступно по внешнему ip и порту 9292  

Создан бакет в YC для хранения state файла  
Настроен удаленный бэкенд, описанный в файле **backend.tf**  
Для корректной работы пришлось откатить terraform на версию 1.5.7  
При применении конфигурации файл *.tfstate создается и хранится в бакете  
Выполнены тесты, при повторном запуске конфигурации из другой папки, получаем уведомление **No changes. Your infrastructure matches the configuration Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.**  

Все настройки продублированы в подпроектах **stage** и **prod**  


## Управление конфигурацией. Знакомство с Ansible 

### Основное задание:  
Установка ansible  
Составлен **inventory** файла  
Протестированы ansible модули без плейбуков  
Настроены параметры в файле **ansible.cfg**  
Модернизирован inventory файл - составлены группы хостов  
Составлен и протестирован **inventory файла yaml формата**  
Протестированы модули **command, shell, service, git**  
Создан и протестирован плейбук **clone.yml**  

### Дополнительное задание:  
Создан скрипт динамического inventory формата json - **inventory.sh**  
При указании в качестве инвентори этого скрипта, будет передан json inventory с адресами, полученными от terraform output.  
